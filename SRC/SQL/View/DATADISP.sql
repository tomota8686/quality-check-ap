--SELECT
--  M02.DISP_ORDER AS No
--, M02.FURYO_ID AS 不良ID
--, FURYO_CON AS 内容
----, CASE WHEN LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') THEN D01.FURYO_NUM
--	   --WHEN LEFT(D01.ADD_YMDHNS, 8) <> FORMAT(GETDATE(),'yyyyMMdd') THEN null
--	   --ELSE NULL
--	   --END AS 不良数
--FROM M02_FURYO AS M02
--LEFT OUTER JOIN M03_HINBAN AS M03 ON M02.BUNRUI_KB = M03.BUNRUI_KB
--LEFT OUTER JOIN D01_RECORD AS D01 ON M02.FURYO_ID = D01.FURYO_ID 
--WHERE M03.HINBAN = 9784798012940
--AND M02.DISP_ORDER <= 5
--ORDER BY DISP_ORDER ASC

SELECT
  M02.DISP_ORDER AS No
, M02.FURYO_ID AS 不良ID
, FURYO_CON AS 内容
, ISNULL(D01.FURYO_NUM, 0)
FROM M02_FURYO AS M02
LEFT OUTER JOIN M03_HINBAN AS M03 ON M02.BUNRUI_KB = M03.BUNRUI_KB
LEFT OUTER JOIN D01_RECORD AS D01 ON M02.FURYO_ID = D01.FURYO_ID AND LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd')
WHERE M03.HINBAN = 9784798012940
AND M02.DISP_ORDER <= 5
ORDER BY DISP_ORDER ASC


--SELECT
--  M02.DISP_ORDER AS No
--, M02.FURYO_ID AS 不良ID
--, M02.FURYO_CON AS 内容
--, CASE WHEN LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') THEN D01.FURYO_NUM
--	   ELSE 0 END AS 不良数
--FROM D01_RECORD AS D01
--INNER JOIN M02_FURYO AS M02 ON D01.FURYO_ID = M02.FURYO_ID
--INNER JOIN M03_HINBAN AS M03 ON D01.HINBAN = M03.HINBAN
--WHERE M03.HINBAN = 9784798012940 AND M02.DISP_ORDER <= 5
--AND LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd')
--ORDER BY M02.DISP_ORDER ASC




SELECT M02.DISP_ORDER AS No, M02.FURYO_ID AS 不良ID, FURYO_CON AS 内容, ISNULL(D01.FURYO_NUM, 0) FROM M02_FURYO AS M02 LEFT OUTER JOIN M03_HINBAN AS M03 ON M02.BUNRUI_KB = M03.BUNRUI_KB LEFT OUTER JOIN D01_RECORD AS D01 ON M02.FURYO_ID = D01.FURYO_ID AND LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') WHERE M03.HINBAN = 9784798012940 AND M02.DISP_ORDER <= 5 ORDER BY DISP_ORDER ASC




--SELECT M02.DISP_ORDER AS No, M02.FURYO_ID AS 不良ID, FURYO_CON AS 内容, CASE WHEN LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') THEN D01.FURYO_NUM ELSE 0 END AS 不良数 FROM M02_FURYO AS M02 LEFT OUTER JOIN M03_HINBAN AS M03 ON M02.BUNRUI_KB = M03.BUNRUI_KB LEFT OUTER JOIN D01_RECORD AS D01 ON M02.FURYO_ID = D01.FURYO_ID WHERE M03.HINBAN = 9784798012940 AND M02.DISP_ORDER > 3 AND(not exists(SELECT * FROM D01_RECORD AS D01 WHERE LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd')) OR LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd')) ORDER BY DISP_ORDER ASC

--SELECT M02.DISP_ORDER AS No, M02.FURYO_ID AS 不良ID, FURYO_CON AS 内容, CASE WHEN LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') THEN D01.FURYO_NUM ELSE 0 END AS 不良数 FROM M02_FURYO AS M02 LEFT OUTER JOIN M03_HINBAN AS M03 ON M02.BUNRUI_KB = M03.BUNRUI_KB LEFT OUTER JOIN D01_RECORD AS D01 ON M02.FURYO_ID = D01.FURYO_ID WHERE M03.HINBAN = 9784798012940 AND M02.DISP_ORDER <= 5 AND not exists(SELECT * FROM D01_RECORD AS D01 WHERE LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd')) OR LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') ORDER BY DISP_ORDER ASC

--SELECT M02.DISP_ORDER AS No, M02.FURYO_ID AS 不良ID,FURYO_CON AS 内容,CASE WHEN LEFT(D01.ADD_YMDHNS, 8) = FORMAT(GETDATE(),'yyyyMMdd') THEN D01.FURYO_NUM ELSE 0 END AS 不良数 FROM M02_FURYO AS M02 LEFT OUTER JOIN M03_HINBAN AS M03 ON M02.BUNRUI_KB = M03.BUNRUI_KB LEFT OUTER JOIN D01_RECORD AS D01 ON M02.FURYO_ID = D01.FURYO_ID WHERE M03.HINBAN = 9784798012940 AND M02.DISP_ORDER <= 5 ORDER BY DISP_ORDER ASC